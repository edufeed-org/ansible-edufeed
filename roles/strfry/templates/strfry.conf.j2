##
## Strfry configuration - Generated by Ansible
##

# Directory that contains the strfry LMDB database (restart required)
db = "/app/strfry-db/"

dbParams {
    # Maximum number of threads/processes that can simultaneously have LMDB transactions open (restart required)
    maxreaders = {{ strfry_db_max_readers | default(256) }}

    # Size of mmap() to use when loading LMDB (default is 10TB, does *not* correspond to disk-space used) (restart required)
    mapsize = {{ strfry_db_map_size | default(10995116277760) }}

    # Disables read-ahead when accessing the LMDB mapping. Reduces IO activity when DB size is larger than RAM. (restart required)
    noReadAhead = {{ strfry_db_no_read_ahead | default(false) | lower }}
}

events {
    # Maximum size of normalised JSON, in bytes
    maxEventSize = {{ strfry_max_event_size | default(65536) }}

    # Events newer than this will be rejected
    rejectEventsNewerThanSeconds = {{ strfry_reject_future_seconds | default(900) }}

    # Events older than this will be rejected
    rejectEventsOlderThanSeconds = {{ strfry_reject_events_older_than_seconds | default(94608000) }}

    # Ephemeral events older than this will be rejected
    rejectEphemeralEventsOlderThanSeconds = {{ strfry_reject_ephemeral_events_older_than_seconds | default(60) }}

    # Ephemeral events will be deleted from the DB when older than this
    ephemeralEventsLifetimeSeconds = {{ strfry_ephemeral_events_lifetime_seconds | default(300) }}

    # Maximum number of tags allowed
    maxNumTags = {{ strfry_max_num_tags | default(2000) }}

    # Maximum size for tag values, in bytes
    maxTagValSize = {{ strfry_max_tag_val_size | default(1024) }}
}

relay {
    # Interface to listen on. Use 0.0.0.0 to listen on all interfaces (restart required)
    bind = "0.0.0.0"

    # Port to open for the nostr websocket protocol (restart required)
    port = {{ strfry_port }}

    # Set OS-limit on maximum number of open files/sockets (if 0, don't attempt to set) (restart required)
    nofiles = {{ strfry_nofiles | default(1000000) }}

    # HTTP header that contains the client's real IP, before reverse proxying (ie x-real-ip) (MUST be all lower-case)
    realIpHeader = "{{ strfry_real_ip_header | default('x-real-ip') }}"

    info {
        # NIP-11: Name of this server. Short/descriptive (< 30 characters)
        name = "{{ strfry_relay_name }}"

        # NIP-11: Detailed information about relay, free-form
        description = "{{ strfry_relay_description }}"

        # NIP-11: Administrative nostr pubkey, for contact purposes
        pubkey = "{{ strfry_relay_pubkey | default('') }}"

        # NIP-11: Alternative administrative contact (email, website, etc)
        contact = "{{ strfry_relay_contact }}"

        # NIP-11: URL pointing to an image to be used as an icon for the relay
        icon = "{{ strfry_relay_icon | default('') }}"

        # List of supported lists as JSON array, or empty string to use default. Example: "[1,2]"
        nips = "{{ strfry_relay_nips | default('') }}"
    }

    # Maximum accepted incoming websocket frame size (should be larger than max event) (restart required)
    maxWebsocketPayloadSize = {{ strfry_max_websocket_payload_size | default(131072) }}

    # Maximum number of filters allowed in a REQ
    maxReqFilterSize = {{ strfry_max_req_filter_size | default(200) }}

    # Websocket-level PING message frequency (should be less than any reverse proxy idle timeouts) (restart required)
    autoPingSeconds = {{ strfry_auto_ping_seconds | default(55) }}

    # If TCP keep-alive should be enabled (detect dropped connections to upstream reverse proxy)
    enableTcpKeepalive = {{ strfry_enable_tcp_keepalive | default(false) | lower }}

    # How much uninterrupted CPU time a REQ query should get during its DB scan
    queryTimesliceBudgetMicroseconds = {{ strfry_query_timeslice_budget_microseconds | default(10000) }}

    # Maximum records that can be returned per filter
    maxFilterLimit = {{ strfry_max_filter_limit | default(500) }}

    # Maximum number of subscriptions (concurrent REQs) a connection can have open at any time
    maxSubsPerConnection = {{ strfry_max_subs_per_connection | default(20) }}

    writePolicy {
        # If non-empty, path to an executable script that implements the writePolicy plugin logic
        plugin = "{{ strfry_write_policy_plugin | default('') }}"
    }

    compression {
        # Use permessage-deflate compression if supported by client. Reduces bandwidth, but slight increase in CPU (restart required)
        enabled = {{ strfry_compression_enabled | default(true) | lower }}

        # Maintain a sliding window buffer for each connection. Improves compression, but uses more memory (restart required)
        slidingWindow = {{ strfry_compression_sliding_window | default(true) | lower }}
    }

    logging {
        # Dump all incoming messages
        dumpInAll = {{ strfry_logging_dump_in_all | default(false) | lower }}

        # Dump all incoming EVENT messages
        dumpInEvents = {{ strfry_logging_dump_in_events | default(false) | lower }}

        # Dump all incoming REQ/CLOSE messages
        dumpInReqs = {{ strfry_logging_dump_in_reqs | default(false) | lower }}

        # Log performance metrics for initial REQ database scans
        dbScanPerf = {{ strfry_logging_db_scan_perf | default(false) | lower }}

        # Log reason for invalid event rejection? Can be disabled to silence excessive logging
        invalidEvents = {{ strfry_logging_invalid_events | default(true) | lower }}
    }

    numThreads {
        # Ingester threads: route incoming requests, validate events/sigs (restart required)
        ingester = {{ strfry_num_threads_ingester | default(3) }}

        # reqWorker threads: Handle initial DB scan for events (restart required)
        reqWorker = {{ strfry_num_threads_req_worker | default(3) }}

        # reqMonitor threads: Handle filtering of new events (restart required)
        reqMonitor = {{ strfry_num_threads_req_monitor | default(3) }}

        # negentropy threads: Handle negentropy protocol messages (restart required)
        negentropy = {{ strfry_num_threads_negentropy | default(2) }}
    }

    negentropy {
        # Support negentropy protocol messages
        enabled = {{ strfry_negentropy_enabled | default(true) | lower }}

        # Maximum records that sync will process before returning an error
        maxSyncEvents = {{ strfry_negentropy_max_sync_events | default(1000000) }}
    }
}